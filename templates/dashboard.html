{% extends "base.html" %}

{% block title %}Dashboard - StudyZee{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 class="title">Dashboard - StudyZee</h1>

    <div class="main-content">
        <!-- Sidebar (User Profile) -->
        <div class="sidebar">
            <a href="{{ url_for('edit_profile') }}">
                <img src="{{ user_data.profile_picture or url_for('static', filename='images/default-pfp.jpg') }}" alt="Profile Picture" class="profile-img">
            </a>
            <h3 class="username">{{ user_data.full_name }}</h3>
            <p class="user-handle">@{{ user_data.username }}</p>
            
            <div class="info-box major">
                <p class="label">Major</p>
                <p class="value">{{ user_data.major }}</p>
            </div>
            <div class="info-box study-level">
                <p class="label">Study Level</p>
                <p class="value">{{ user_data.study_level }}</p>
            </div>

            <button onclick="openFriendRequests()">Friend Requests</button>

            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>

        <!-- Courses Section -->
        <div class="courses-section">
            <div class="courses-header">
                <h3>Courses</h3>
                <a href="{{ url_for('add_course') }}" class="add-btn" style="background: #F8AFAF; color: white;">Add</a>
            </div>
            <ul class="courses-list">
                {% for course in courses %}
                    <li class="course-item">{{ course }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Friends & Chat Section -->
        <div class="friends-section">
            <h3>Your Friends</h3>
            <ul id="friends-list"></ul>
        </div>
        
        <script>
        fetch('/friends_list')
            .then(response => response.json())
            .then(data => {
                let list = document.getElementById('friends-list');
                data.friends.forEach(friend => {
                    let li = document.createElement("li");
                    li.innerHTML = `${friend.email} 
                        <button onclick="startPrivateChat('${friend.room_code}')">Message</button>`;
                    list.appendChild(li);
                });
            });
        
        function startPrivateChat(roomCode) {
            window.location.href = `/chat?room=${roomCode}`;
        }
        </script>
        
    </div>
</div>

<!-- Assignments Section -->
<div class="assignments-section">
    <h3>Assignments</h3>
    <ul class="assignments-list">
        {% for task in tasks %}
        <li class="assignment-item" id="task-{{ loop.index0 }}">
            <input type="checkbox" {% if task[2] %}checked{% endif %} onclick="window.location.href='{{ url_for('complete_task', task_id=task[3], type=task[4]) }}'">
            {{ task[0] }} - Due: {{ task[1] if task[1] else 'No due date' }}
        </li>
        {% endfor %}
    </ul>
</div>

<!-- Friend Requests Modal -->
<div id="friendRequestsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeFriendRequests()">&times;</span>
        <h3>Friend Requests</h3>
        <ul id="requests-list"></ul>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
<script>

// Fetch and Display Friend Requests in the Modal
function openFriendRequests() {
    fetch('/friend_requests')
        .then(response => response.json())
        .then(data => {
            let list = document.getElementById('requests-list');
            list.innerHTML = "";  // Clear previous requests
            data.requests.forEach(req => {
                let li = document.createElement("li");
                li.innerHTML = `${req.sender_email} - ${req.message} 
                    <button onclick="respondRequest('${req.id}', 'accepted')">Accept</button>
                    <button onclick="respondRequest('${req.id}', 'rejected')">Reject</button>`;
                list.appendChild(li);
            });
        });

    document.getElementById("friendRequestsModal").style.display = "block";
}

function closeFriendRequests() {
    document.getElementById("friendRequestsModal").style.display = "none";
}

function respondRequest(requestId, response) {
    fetch('/respond_friend_request', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ request_id: requestId, response: response })
    }).then(() => {
        alert("Friend request " + response);
        closeFriendRequests();
        location.reload();
    });
}
</script>

<style>
/* Modal Styling */
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 50%;
    text-align: center;
    border-radius: 10px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

/* Friends Section */
.friends-section {
    background: #D0F0C0;
    padding: 15px;
    border-radius: 15px;
    text-align: left;
}

.friends-section ul {
    list-style: none;
    padding: 0;
}

.friends-section li {
    background: #A3D9A5;
    padding: 8px;
    border-radius: 10px;
    margin: 5px 0;
}
</style>

{% endblock %}

759b9b71-243d-4175-b4ad-4cc215e041c1
65ef908f-7efe-41eb-af9c-ebd9f1baf145
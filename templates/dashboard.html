{% extends "base.html" %}
{% block title %}Dashboard - StudyZee{% endblock %}

{% block styles %}
<style>
  /* Dashboard responsive grid */
  @media (max-width: 1024px) {
    .dashboard-main-grid {
      grid-template-columns: 1fr 1fr !important;
    }
  }
  
  @media (max-width: 768px) {
    .dashboard-main-grid {
      grid-template-columns: 1fr !important;
    }
    
    /* Make profile photo smaller on mobile */
    .profile-photo-mobile {
      width: 120px !important;
      height: 120px !important;
    }
    
    /* Stack stat cards 2x2 on mobile */
    .stats-grid-mobile {
      grid-template-columns: repeat(2, 1fr) !important;
    }
  }
  
  @media (max-width: 480px) {
    /* Profile photo even smaller on tiny screens */
    .profile-photo-mobile {
      width: 100px !important;
      height: 100px !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Welcome Header -->
  <div style="text-align: center; margin-bottom: 3rem;">
    <h1 class="page-title">Welcome back, {{ user.full_name }}!</h1>
    <p style="color: var(--gray-700); font-size: 1.125rem;">Let's make today productive</p>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-4 stats-grid-mobile" style="margin-bottom: 2rem;">
    <div class="card" style="background: #2563eb; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Courses</p>
          <p style="font-size: 2rem; font-weight: 800;">{{ courses|length }}</p>
        </div>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
      </div>
    </div>

    <div class="card" style="background: #8b5cf6; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Assignments</p>
          <p style="font-size: 2rem; font-weight: 800;">{{ tasks|length }}</p>
        </div>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">
          <path d="M9 11l3 3L22 4"></path>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
      </div>
    </div>

    <div class="card" style="background: #10b981; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Friends</p>
          <p style="font-size: 2rem; font-weight: 800;" id="friends-count">0</p>
        </div>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
      </div>
    </div>

    <div class="card" style="background: #f59e0b; color: white;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Study Level</p>
          <p style="font-size: 1.25rem; font-weight: 700; text-transform: capitalize;">{{ user.study_level }}</p>
        </div>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">
          <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
          <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-3 dashboard-main-grid" style="grid-template-columns: 1fr 2fr 1.5fr;">
    <!-- Profile Card -->
    <div class="card" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px solid var(--gray-200);">
      <div style="text-align: center;">
        <a href="{{ url_for('social.edit_profile') }}" style="display: block; margin-bottom: 1.5rem;">
          <div style="position: relative; display: inline-block;">
            <img src="{{ user.profile_picture or url_for('static', filename='images/default-pfp.jpg') }}" 
                 alt="Profile" 
                 class="profile-photo-mobile"
                 style="width: 160px; 
                        height: 160px;
                        border-radius: 50%; 
                        object-fit: cover; 
                        cursor: pointer; 
                        border: 6px solid white;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                        transition: transform 0.3s ease;"
                 onmouseover="this.style.transform='scale(1.05)'"
                 onmouseout="this.style.transform='scale(1)'">
            <div style="position: absolute; 
                        bottom: 10px; 
                        right: 10px; 
                        width: 40px; 
                        height: 40px; 
                        background: var(--primary); 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        border: 4px solid white;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </div>
          </div>
        </a>
        
        <h3 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--gray-900);">{{ user.full_name }}</h3>
        <p style="color: var(--gray-500); margin-bottom: 0.5rem; font-size: 1rem;">@{{ user.username }}</p>
        <p style="color: var(--gray-600); margin-bottom: 2rem; font-size: 0.875rem;">{{ user.email }}</p>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="background: white; padding: 1rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
            <p style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Major</p>
            <p style="font-weight: 700; color: var(--gray-900); font-size: 1rem;">{{ user.major }}</p>
          </div>
          <div style="background: white; padding: 1rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
            <p style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Study Level</p>
            <p style="font-weight: 700; color: var(--gray-900); font-size: 1rem; text-transform: capitalize;">{{ user.study_level }}</p>
          </div>
          <div style="background: white; padding: 1rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
            <p style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Year</p>
            <p style="font-weight: 700; color: var(--gray-900); font-size: 1rem;">Year {{ user.year_of_study }}</p>
          </div>
        </div>
        
        <a href="{{ url_for('social.edit_profile') }}" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Edit Profile
        </a>
      </div>
    </div>

    <!-- Courses Card -->
    <div class="card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; font-size: 1.5rem;">My Courses</h3>
        <a href="{{ url_for('courses.add_course') }}" class="btn btn-primary btn-sm">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Add Course
        </a>
      </div>
      
      {% if courses %}
      <div style="display: grid; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
        {% for course in courses %}
        <a href="{{ url_for('courses.course_page', course_id=course['id']) }}" style="text-decoration: none;">
          <div style="background: linear-gradient(135deg, var(--primary-light), var(--primary)); 
                      color: white; 
                      padding: 1.25rem; 
                      border-radius: var(--radius-lg); 
                      transition: var(--transition);
                      cursor: pointer;"
               onmouseover="this.style.transform='translateX(4px)'"
               onmouseout="this.style.transform='translateX(0)'">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <p style="font-weight: 700; font-size: 1.125rem; margin-bottom: 0.25rem;">
                  {{ course['subject_id'] }} {{ course['course_code'] }}
                </p>
                <p style="opacity: 0.9; font-size: 0.875rem;">{{ course['name'] or 'Course' }}</p>
              </div>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div style="text-align: center; padding: 3rem 1rem; color: var(--gray-500);">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 1rem; opacity: 0.3;">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
        </svg>
        <p style="font-weight: 600; margin-bottom: 0.5rem;">No courses yet</p>
        <p style="font-size: 0.875rem;">Add your first course to get started</p>
      </div>
      {% endif %}
    </div>

    <!-- Friends Card -->
    <div class="card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0; font-size: 1.5rem;">Friends</h3>
        <button onclick="openFriendRequests()" class="btn btn-secondary btn-sm">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          Requests
        </button>
      </div>
      
      <div id="friends-list" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto;"></div>
      
      <a href="{{ url_for('social.meet_new_friends') }}" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Meet New Friends
      </a>
    </div>
  </div>

  <!-- Assignments Section -->
  <div class="card" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3 style="margin: 0; font-size: 1.5rem;">Upcoming Assignments</h3>
      <select onchange="window.location.href='{{ url_for('dashboard.dashboard') }}?month=' + this.value" 
              class="form-select" style="width: auto; min-width: 200px;">
        <option value="current" {% if filter_month == 'current' %}selected{% endif %}>This Month</option>
        <option value="all" {% if filter_month == 'all' %}selected{% endif %}>All Upcoming</option>
        <option value="{{ current_date.strftime('%Y-%m') }}" {% if filter_month == current_date.strftime('%Y-%m') %}selected{% endif %}>{{ current_date.strftime('%B %Y') }}</option>
      </select>
    </div>
    
    {% if tasks %}
    <div style="display: grid; gap: 0.75rem;">
      {% for task in tasks %}
      <div class="assignment-item" style="background: var(--gray-50); 
                                           padding: 1rem; 
                                           border-radius: var(--radius-md); 
                                           border-left: 4px solid var(--primary);
                                           display: flex;
                                           align-items: center;
                                           gap: 1rem;">
        <input type="checkbox" {% if task[2] %}checked{% endif %} 
               style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary);" />
        <div style="flex: 1;">
          <p style="font-weight: 600; margin-bottom: 0.25rem; color: var(--gray-800);">{{ task[0] }}</p>
          <p style="font-size: 0.875rem; color: var(--gray-600);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 4px;">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Due: {{ task[1] if task[1] else 'No due date' }}
          </p>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem 1rem; color: var(--gray-500);">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 1rem; opacity: 0.3;">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      <p style="font-weight: 600; margin-bottom: 0.5rem;">No assignments</p>
      <p style="font-size: 0.875rem;">You're all caught up!</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Friend Requests Modal -->
<div id="friendRequestsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Friend Requests</h3>
      <button class="modal-close" onclick="closeFriendRequests()">&times;</button>
    </div>
    <div class="modal-body">
      <ul id="requests-list" style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 1rem;"></ul>
    </div>
  </div>
</div>

<script>
  // Fetch and Display Friends
  fetch("/friends_list")
    .then((response) => response.json())
    .then((data) => {
      let list = document.getElementById("friends-list");
      let count = document.getElementById("friends-count");
      
      count.textContent = data.friends.length;
      
      if (data.friends.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 2rem 1rem; color: var(--gray-500);">
            <p style="font-weight: 600; margin-bottom: 0.5rem;">No friends yet</p>
            <p style="font-size: 0.875rem;">Start connecting with others!</p>
          </div>
        `;
        return;
      }
      
      data.friends.forEach((friend) => {
        let div = document.createElement("div");
        div.style.cssText = "background: var(--gray-50); padding: 0.75rem; border-radius: var(--radius-md); display: flex; justify-content: space-between; align-items: center;";
        div.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
              ${friend.username.charAt(0).toUpperCase()}
            </div>
            <div>
              <p style="font-weight: 600; color: var(--gray-800); margin-bottom: 0.125rem;">@${friend.username}</p>
              <p style="font-size: 0.75rem; color: var(--gray-600);">${friend.full_name || 'Friend'}</p>
            </div>
          </div>
          <button onclick="startPrivateChat('${friend.id}')" class="btn btn-primary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </button>
        `;
        list.appendChild(div);
      });
    });

  function startPrivateChat(friendId) {
    window.location.href = `/chat/${friendId}`;
  }

  function openFriendRequests() {
    fetch("/friend_requests")
      .then((response) => response.json())
      .then((data) => {
        let list = document.getElementById("requests-list");
        list.innerHTML = "";

        if (data.requests.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No new friend requests.</p>';
          document.getElementById("friendRequestsModal").classList.add("active");
          return;
        }

        data.requests.forEach((req) => {
          let li = document.createElement("li");
          li.innerHTML = `
            <div style="background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md); border-left: 4px solid var(--primary);">
              <p style="font-weight: 700; margin-bottom: 0.5rem; color: var(--gray-800);">${req.sender_email}</p>
              <p style="color: var(--gray-600); margin-bottom: 1rem; font-size: 0.875rem;">${req.message}</p>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-success btn-sm" onclick="respondRequest('${req.id}', 'accepted')" style="flex: 1;">Accept</button>
                <button class="btn btn-secondary btn-sm" onclick="respondRequest('${req.id}', 'rejected')" style="flex: 1;">Reject</button>
              </div>
            </div>
          `;
          list.appendChild(li);
        });

        document.getElementById("friendRequestsModal").classList.add("active");
      });
  }

  function closeFriendRequests() {
    document.getElementById("friendRequestsModal").classList.remove("active");
  }

  function respondRequest(requestId, response) {
    fetch("/respond_friend_request", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ request_id: requestId, response: response }),
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert("Error: " + data.error);
      } else {
        closeFriendRequests();
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("Failed to respond to friend request");
    });
  }
</script>
{% endblock %}

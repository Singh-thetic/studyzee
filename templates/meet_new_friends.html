{% extends "base.html" %} 
{% block title %}Meet New Friends - StudyZee{% endblock %} 

{% block content %}
<div class="container container-sm">
  <div style="text-align: center; margin-bottom: 3rem;">
    <h1 class="page-title">Meet New Friends</h1>
    <p style="color: var(--gray-700); font-size: 1.125rem;">Connect with students who share your interests</p>
  </div>

  <div class="card">
    <h2 class="card-header">Suggested Friends</h2>
    <div id="suggestions-list" style="display: flex; flex-direction: column; gap: 1rem;"></div>
    
    <div style="text-align: center; margin-top: 2rem;">
      <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-secondary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Back to Dashboard
      </a>
    </div>
  </div>
</div>

<!-- Friend Request Modal -->
<div id="friendRequestModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3 class="modal-title">Send Friend Request</h3>
      <button class="modal-close" onclick="closeFriendRequestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p id="friend-name" style="font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;"></p>
      <div class="form-group">
        <label class="form-label">Add a message (optional)</label>
        <textarea id="friend-message" class="form-textarea" rows="3" placeholder="Hi! I'd like to connect with you..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeFriendRequestModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmFriendRequest()">Send Request</button>
    </div>
  </div>
</div>

<script>
  let currentReceiverId = null;

  function fetchSuggestedFriends() {
    const suggestionsList = document.getElementById("suggestions-list");
    suggestionsList.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
    
    fetch("/suggested_friends")
      .then(response => response.json())
      .then(data => {
        suggestionsList.innerHTML = "";
        
        if (data.suggestions.length === 0) {
          suggestionsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem; color: var(--gray-500);">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin: 0 auto 1rem; opacity: 0.3;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <p style="font-weight: 600; margin-bottom: 0.5rem;">No suggestions at the moment</p>
              <p style="font-size: 0.875rem;">Check back later for new connections!</p>
            </div>
          `;
          return;
        }
        
        data.suggestions.forEach(user => {
          const div = document.createElement("div");
          div.style.cssText = "background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-lg); border-left: 4px solid var(--primary);";
          
          div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem;">
                  ${user.full_name}
                </h3>
                <p style="color: var(--gray-600); margin-bottom: 0.75rem; font-size: 0.9375rem;">
                  ${user.email}
                </p>
                <div style="display: inline-flex; align-items: center; background: rgba(99, 102, 241, 0.1); 
                            padding: 0.375rem 0.75rem; border-radius: var(--radius-full); margin-bottom: 0.75rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" style="margin-right: 0.5rem;">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <span style="color: var(--primary); font-size: 0.875rem; font-weight: 600;">${user.match_reason}</span>
                </div>
              </div>
              <button class="btn btn-primary btn-sm" onclick="openFriendRequestModal('${user.id}', '${user.full_name}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <line x1="20" y1="8" x2="20" y2="14"></line>
                  <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Add Friend
              </button>
            </div>
          `;
          
          suggestionsList.appendChild(div);
        });
      })
      .catch(error => {
        console.error("Error:", error);
        suggestionsList.innerHTML = `
          <div class="alert alert-error">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Failed to load suggestions
          </div>
        `;
      });
  }

  function openFriendRequestModal(receiverId, fullName) {
    currentReceiverId = receiverId;
    document.getElementById("friend-name").textContent = `Send friend request to ${fullName}`;
    document.getElementById("friend-message").value = "";
    document.getElementById("friendRequestModal").classList.add("active");
  }

  function closeFriendRequestModal() {
    document.getElementById("friendRequestModal").classList.remove("active");
    currentReceiverId = null;
  }

  function confirmFriendRequest() {
    const message = document.getElementById("friend-message").value || "Hi! I'd like to connect with you.";
    
    fetch("/send_friend_request", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ receiver_id: currentReceiverId, message: message })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        closeFriendRequestModal();
        
        // Show success notification
        const successDiv = document.createElement("div");
        successDiv.className = "alert alert-success";
        successDiv.style.cssText = "position: fixed; top: 100px; right: 20px; z-index: 9999; max-width: 400px;";
        successDiv.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          ${data.message}
        `;
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
        
        // Refresh suggestions
        fetchSuggestedFriends();
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Failed to send friend request. Please try again.");
    });
  }

  // Load suggested friends on page load
  document.addEventListener("DOMContentLoaded", fetchSuggestedFriends);
</script>
{% endblock %}
